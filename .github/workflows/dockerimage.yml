name: Docker Image CI

on: [push]

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build image
      run: docker build . --file Dockerfile --tag image
    - name: Docker login
      run: docker login --username gregorigoss --password ${{ secrets.dockerhub_access_token }}         
    - name: Push image
      run: |
        DOCKER_TAG=latest
        echo REF: ${{ github.ref }}
        if [[ ${{ github.ref }} =~ refs/tags/(.+) ]]
        then
           # tag is pushed
           DOCKER_TAG=${BASH_REMATCH[1]}
        elif [[ ${{ github.ref }} =~ refs/heads/(.+) ]]
        then
           # branch is pushed
           echo "::set-env name=GIT_BRANCH::${BASH_REMATCH[1]}"
           DOCKER_TAG=${BASH_REMATCH[1]}-$(date +%s)
        fi
        echo Pushing origoss/github-actions-demo:${DOCKER_TAG} 
        docker tag image origoss/github-actions-demo:${DOCKER_TAG} 
        docker push origoss/github-actions-demo:${DOCKER_TAG}
    - uses: actions/checkout@v2
      with:
        repository: origoss/kustomize-to-walls
        token: ${{secrets.github_access_token }}
        path: kustomize-repo
    - name: Create a new file
      run: |
        cd kustomize-repo/manifests/overlays
        if [[ -d ${{ env.GIT_BRANCH }} ]]; then
          echo "git overlay for branch exists"
          cd ${{ env.GIT_BRANCH }}
          echo $(date) > date.txt
          git add date.txt
          git config user.name "CI of github-actions-demo"
          git config user.email "noreply@ci.origoss.com"
          git commit -am "Updating date.txt"
          git push
        fi
